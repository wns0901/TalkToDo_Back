name: Build and Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Gradle ì„¤ì •
        uses: gradle/actions/setup-gradle@v4.0.0

      - name: gradlew ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Gradle Wrapper ë¡œ ë¹Œë“œ
        run: ./gradlew build -x test

      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build, Push Docker image
        run: |
          docker build -f ./Dockerfile -t wns0901/talktodo-server:latest .
          docker push wns0901/talktodo-server:latest

      - name: .env íŒŒì¼ ìƒì„±
        run: |
          echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" > .env
          echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
          echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
          echo "SPRING_MAIL_USERNAME=${{ secrets.SPRING_MAIL_USERNAME }}" >> .env
          echo "SPRING_MAIL_PASSWORD=${{ secrets.SPRING_MAIL_PASSWORD }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "CLOUD_AWS_S3_BUCKET=${{ secrets.CLOUD_AWS_S3_BUCKET }}" >> .env
          echo "CLOUD_AWS_REGION_STATIC=${{ secrets.CLOUD_AWS_REGION_STATIC }}" >> .env
          echo "CLOUD_AWS_CREDENTIALS_ACCESS_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}" >> .env
          echo "CLOUD_AWS_CREDENTIALS_SECRET_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_KEY }}" >> .env
          echo "API_URL=${{ secrets.API_URL }}" >> .env

      - name: EC2 ì— íŒŒì¼ ì—…ë¡œë“œ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: ".env,docker-compose.yml,nginx-spring.conf"
          target: "/home/ubuntu/TalkToDo"
          strip_components: 0

      - name: EC2 ì—ì„œ ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ubuntu/TalkToDo

            # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. Dockerë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
              sudo apt-get update
              sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
              echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ubuntu
              echo "âœ… Docker ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "âœ… Dockerê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi

            # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Docker Composeë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              echo "âœ… Docker Compose ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "âœ… Docker Composeê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi

            # Docker ë¡œê·¸ì¸
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            sudo docker stop $(sudo docker ps -aq) 2>/dev/null || true
            sudo docker rm $(sudo docker ps -aq) 2>/dev/null || true

            # Docker Composeë¡œ ë°°í¬ (SSL í”„ë¡œí•„ í¬í•¨)
            sudo /usr/local/bin/docker-compose --profile ssl pull
            sudo /usr/local/bin/docker-compose --profile ssl up -d

            # ë°°í¬ í›„ ìƒíƒœ í™•ì¸
            echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 30

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            sudo docker ps -a

            # í¬íŠ¸ ìƒíƒœ í™•ì¸
            sudo netstat -tlnp | grep :8080 || echo "í¬íŠ¸ 8080ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸
            sudo docker-compose logs --tail=20

            # SSL ì¸ì¦ì„œ ì„¤ì • (ë„ë©”ì¸ì´ ì„¤ì •ëœ ê²½ìš°)
            DOMAIN="api-talktodo.kro.kr"
            if [ ! -z "$DOMAIN" ] && [ "$DOMAIN" != "yourdomain.com" ]; then
              echo "ğŸ”’ SSL ì¸ì¦ì„œ ì„¤ì •ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
              
              # Certbot ì„¤ì¹˜
              if ! command -v certbot &> /dev/null; then
                echo "ğŸ“¦ Certbotì„ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
                sudo apt-get update
                sudo apt-get install -y certbot
              fi
              
              # SSL ì¸ì¦ì„œ ë°œê¸‰
              sudo certbot certonly --standalone -d $DOMAIN --non-interactive --agree-tos --email ${{ secrets.EMAIL }} || echo "SSL ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨ (ë„ë©”ì¸ ì„¤ì • í™•ì¸ í•„ìš”)"
              
              # Nginx ì„¤ì¹˜ ë° ì„¤ì •
              if [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
                echo "âœ… SSL ì¸ì¦ì„œê°€ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. Nginxë¥¼ ì„¤ì •í•©ë‹ˆë‹¤..."
                sudo apt-get install -y nginx
                
                # Nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
                sudo cp nginx-spring.conf /etc/nginx/sites-available/talktodo
                sudo ln -sf /etc/nginx/sites-available/talktodo /etc/nginx/sites-enabled/
                sudo rm -f /etc/nginx/sites-enabled/default
                
                # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘
                sudo nginx -t && sudo systemctl restart nginx
                sudo systemctl enable nginx
                
                echo "ğŸ‰ SSL ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
                echo "ğŸŒ HTTPS ì ‘ì†: https://$DOMAIN"
              else
                echo "âš ï¸  SSL ì¸ì¦ì„œ ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê¸°ì¡´ ì¸ì¦ì„œë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
                
                # ê¸°ì¡´ ì¸ì¦ì„œ í™•ì¸ (ë””ë ‰í† ë¦¬ ë˜ëŠ” íŒŒì¼ ì¡´ì¬ ì—¬ë¶€)
                if [ -d "/etc/letsencrypt/live/$DOMAIN" ] || [ -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
                  echo "âœ… ê¸°ì¡´ SSL ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤."
                  sudo apt-get install -y nginx
                  
                  # Nginx ì„¤ì • íŒŒì¼ ë³µì‚¬
                  sudo cp nginx-spring.conf /etc/nginx/sites-available/talktodo
                  sudo ln -sf /etc/nginx/sites-available/talktodo /etc/nginx/sites-enabled/
                  sudo rm -f /etc/nginx/sites-enabled/default
                  
                  # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ë° ì¬ì‹œì‘
                  sudo nginx -t && sudo systemctl restart nginx
                  sudo systemctl enable nginx
                  
                  echo "ğŸ‰ ê¸°ì¡´ SSL ì¸ì¦ì„œë¡œ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
                  echo "ğŸŒ HTTPS ì ‘ì†: https://$DOMAIN"
                else
                  echo "âŒ SSL ì¸ì¦ì„œê°€ ì—†ìŠµë‹ˆë‹¤. HTTPë¡œë§Œ ì„œë¹„ìŠ¤ë©ë‹ˆë‹¤."
                fi
              fi
            else
              echo "âš ï¸  ë„ë©”ì¸ì´ ì„¤ì •ë˜ì§€ ì•Šì•„ SSL ì„¤ì •ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            fi
