name: Build and Deploy to EC2

on:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Gradle ì„¤ì •
        uses: gradle/actions/setup-gradle@v4.0.0

      - name: gradlew ì— ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: Gradle Wrapper ë¡œ ë¹Œë“œ
        run: ./gradlew build -x test

      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build, Push Docker image
        run: |
          docker build -f ./Dockerfile -t wns0901/talktodo-server:latest .
          docker push wns0901/talktodo-server:latest

      - name: .env íŒŒì¼ ìƒì„±
        run: |
          echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" > .env
          echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
          echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
          echo "SPRING_MAIL_USERNAME=${{ secrets.SPRING_MAIL_USERNAME }}" >> .env
          echo "SPRING_MAIL_PASSWORD=${{ secrets.SPRING_MAIL_PASSWORD }}" >> .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "CLOUD_AWS_S3_BUCKET=${{ secrets.CLOUD_AWS_S3_BUCKET }}" >> .env
          echo "CLOUD_AWS_REGION_STATIC=${{ secrets.CLOUD_AWS_REGION_STATIC }}" >> .env
          echo "CLOUD_AWS_CREDENTIALS_ACCESS_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}" >> .env
          echo "CLOUD_AWS_CREDENTIALS_SECRET_KEY=${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_KEY }}" >> .env
          echo "API_URL=${{ secrets.API_URL }}" >> .env

      - name: .env íŒŒì¼ ì—…ë¡œë“œ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: ".env"
          target: "/home/ubuntu/TalkToDo"
          strip_components: 0

      - name: docker-compose.yml íŒŒì¼ ì—…ë¡œë“œ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "docker-compose.yml"
          target: "/home/ubuntu/TalkToDo"
          strip_components: 0

      - name: SSL ì¸ì¦ì„œ íŒŒì¼ë“¤ ìƒì„±
        run: |
          echo "${{ secrets.CA_BUNDLE_CRT }}" > ca_bundle.crt
          echo "${{ secrets.CERTIFICATE_CRT }}" > certificate.crt
          echo "${{ secrets.PRIVATE_KEY }}" > private.key

      - name: ê¸°ì¡´ SSL íŒŒì¼ ì •ë¦¬
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            echo "ğŸ§¹ ê¸°ì¡´ SSL íŒŒì¼ ì •ë¦¬ ì¤‘..."
            sudo rm -f /home/ubuntu/TalkToDo/ssl/ca_bundle.crt
            sudo rm -f /home/ubuntu/TalkToDo/ssl/certificate.crt
            sudo rm -f /home/ubuntu/TalkToDo/ssl/private.key
            echo "âœ… ê¸°ì¡´ SSL íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"

      - name: SSL ì¸ì¦ì„œ íŒŒì¼ë“¤ ì—…ë¡œë“œ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "ca_bundle.crt,certificate.crt,private.key"
          target: "/home/ubuntu/TalkToDo/ssl"
          strip_components: 0

      - name: Nginx ì„¤ì • íŒŒì¼ ì—…ë¡œë“œ
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "nginx.conf"
          target: "/home/ubuntu/TalkToDo"
          strip_components: 0

      - name: EC2 ì—ì„œ ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/ubuntu/TalkToDo

            # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. Dockerë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
              sudo apt-get update
              sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
              echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -a -G docker ubuntu
              echo "âœ… Docker ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "âœ… Dockerê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi

            # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Docker Composeë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              echo "âœ… Docker Compose ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "âœ… Docker Composeê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi

            # Docker ë¡œê·¸ì¸
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            sudo docker stop $(sudo docker ps -aq) 2>/dev/null || true
            sudo docker rm $(sudo docker ps -aq) 2>/dev/null || true

            # Docker Composeë¡œ ë°°í¬
            sudo /usr/local/bin/docker-compose pull
            sudo /usr/local/bin/docker-compose up -d

            # ë°°í¬ í›„ ìƒíƒœ í™•ì¸
            echo "ğŸ” ë°°í¬ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 30

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            sudo docker ps -a

            # í¬íŠ¸ ìƒíƒœ í™•ì¸
            sudo netstat -tlnp | grep :8080 || echo "í¬íŠ¸ 8080ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"

            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸
            sudo docker-compose logs --tail=20

            echo "âœ… Docker ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ğŸŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì ‘ì†: http://${{ secrets.EC2_HOST }}:8080"

            # Nginx ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ“¦ Nginx ì„¤ì¹˜ í™•ì¸ ì¤‘..."
            if ! command -v nginx &> /dev/null; then
              echo "ğŸ³ Nginxê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. Nginxë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤..."
              sudo apt-get update
              sudo apt-get install -y nginx
              sudo systemctl enable nginx
              echo "âœ… Nginx ì„¤ì¹˜ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "âœ… Nginxê°€ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
            fi

            # SSL ì¸ì¦ì„œ íŒŒì¼ ê¶Œí•œ ì„¤ì •
            echo "ğŸ” SSL ì¸ì¦ì„œ íŒŒì¼ ê¶Œí•œ ì„¤ì • ì¤‘..."
            sudo chmod 644 /home/ubuntu/TalkToDo/ssl/certificate.crt
            sudo chmod 644 /home/ubuntu/TalkToDo/ssl/ca_bundle.crt
            sudo chmod 600 /home/ubuntu/TalkToDo/ssl/private.key
            sudo chown -R root:root /home/ubuntu/TalkToDo/ssl

            # Nginx ì„¤ì • íŒŒì¼ ì ìš©
            echo "âš™ï¸ Nginx ì„¤ì • ì ìš© ì¤‘..."
            sudo cp /home/ubuntu/TalkToDo/nginx.conf /etc/nginx/sites-available/talktodo
            sudo ln -sf /etc/nginx/sites-available/talktodo /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default

            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
            echo "ğŸ§ª Nginx ì„¤ì • í…ŒìŠ¤íŠ¸ ì¤‘..."
            sudo nginx -t

            if [ $? -eq 0 ]; then
              echo "âœ… Nginx ì„¤ì •ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤."
              
              # Nginx ì¬ì‹œì‘
              echo "ğŸ”„ Nginx ì¬ì‹œì‘ ì¤‘..."
              sudo systemctl restart nginx
              
              # Nginx ìƒíƒœ í™•ì¸
              echo "ğŸ“‹ Nginx ìƒíƒœ í™•ì¸:"
              sudo systemctl status nginx --no-pager
              
              echo "ğŸ‰ SSL ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
              echo "ğŸ”’ HTTPS ì ‘ì†: https://api-talktodo.kro.kr"
              echo "ğŸ“Š í¬íŠ¸ ìƒíƒœ:"
              sudo netstat -tlnp | grep -E ":80|:443|:8080"
              
              # ë³´ì•ˆ ê·¸ë£¹ í™•ì¸ (EC2 ì¸ìŠ¤í„´ìŠ¤ì—ì„œ)
              echo "ğŸ” ë³´ì•ˆ ê·¸ë£¹ í™•ì¸:"
              echo "80 í¬íŠ¸ í™•ì¸:"
              sudo netstat -tlnp | grep :80 || echo "80 í¬íŠ¸ê°€ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
              echo "443 í¬íŠ¸ í™•ì¸:"
              sudo netstat -tlnp | grep :443 || echo "443 í¬íŠ¸ê°€ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
              echo "8080 í¬íŠ¸ í™•ì¸:"
              sudo netstat -tlnp | grep :8080 || echo "8080 í¬íŠ¸ê°€ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
              
              # Nginx ìƒíƒœ ìƒì„¸ í™•ì¸
              echo "ğŸ“‹ Nginx ìƒì„¸ ìƒíƒœ:"
              sudo systemctl status nginx --no-pager -l
              
              # Nginx ì„¤ì • íŒŒì¼ í™•ì¸
              echo "ğŸ“„ Nginx ì„¤ì • íŒŒì¼ í™•ì¸:"
              sudo nginx -T | grep -E "listen|server_name"
            else
              echo "âŒ Nginx ì„¤ì •ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤."
              exit 1
            fi
